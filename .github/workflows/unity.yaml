name: Update upm branch on release
on:
  release:
    types: [published]
jobs:
  build:
    name: Build and commit to upm branch
    runs-on: ubuntu-latest
    steps:
      - name: Checkout release
        uses: actions/checkout@v3
        with:
          ref: ${{ github.ref }}
      - name: Fetch branch
        run: git fetch origin upm:upm || true
      - name: Create upm branch if it does not yet exist
        run: git branch upm || true
      - name: Move to upm branch without changing working copy
        run: |
          git checkout --detach
          git reset --soft upm
          git checkout upm
      - name: Remove everything except for our project
        run: |
          git rm -rf .
          git checkout --detach
          git reset --soft master
          git checkout master
          git checkout HEAD -- Unity
          git checkout --detach
          git reset --soft upm
          git checkout upm
      - name: Create UPM package for our project
        run: |
          git mv Unity/Assets/* .
          git rm -rf Unity
          git rm -f Readme.md
          git rm -f Readme.md.meta
          git mv Samples Samples~
          git rm -f Samples.meta
          ls -R | grep ":$" | sed -e 's/:$//' -e 's/[^-][^\/]*\//  /g' -e 's/^/   /'
      - name: Config user name
        run: git config --global user.name "github-actions[bot]"
      - name: Config user email
        run: git config --global user.email "41898282+github-actions[bot]@users.noreply.github.com"
      - name: Add
        run: git add *
      - name: Commit
        run: git commit -m "Add upm package for ${GITHUB_REF#refs/*/}"
      - name: Tag
        run: git tag -a ${GITHUB_REF#refs/*/}-upm -m ""
      - name: Push
        run: git push --follow-tags --set-upstream origin upm
